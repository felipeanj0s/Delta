# ==============================================================================
# GT Monitoramento 2025
# Variáveis Globais do Projeto
# Arquivo: group_vars/all.yml
# Descrição: Este arquivo contém variáveis globais utilizadas nos roles:
#           - net_security (roles/net_security)
#           - pre_checks   (roles/pre_checks)
#           - zabbix_proxy (roles/zabbix_proxy)
#           - zabbix_agent (roles/zabbix_agent)
# Versão: 2.1
# Data: 2025-08-11
# Feito por: Felipe Anjos <felipe.anjos@pop-ce.rnp.br
# ==============================================================================

# --- Configurações de Versão e Repositório Zabbix ---
# Define as variáveis para o repositório e pacotes do Zabbix.
zabbix_version: "7.4"
zabbix_repo_file: "zabbix-release_latest_7.4+ubuntu22.04_all.deb"
zabbix_repo_url: "https://repo.zabbix.com/zabbix/{{ zabbix_version }}/release/ubuntu/pool/main/z/zabbix-release/{{ zabbix_repo_file }}"
zabbix_proxy_package: "zabbix-proxy-sqlite3"
zabbix_agent_package: "zabbix-agent2"

# --- Rede (parâmetros genéricos) ---
# A interface de rede (ex: eth0, ens0) agora é definida em cada arquivo de localidade.
netplan_addresses:
  - "{{ netplan_ipv4_address }}"
  - "{{ netplan_ipv6_address }}"
netplan_nameservers: "{{ netplan_dns_list }}"
netplan_routes:
  - to: default
    via: "{{ netplan_ipv4_gateway }}"
    metric: 50
  - to: default
    via: "{{ netplan_ipv6_gateway }}"

# --- Configuração do Zabbix Proxy (comum / arquivos e paths) ---
zabbix_proxy_dbname: "/var/lib/zabbix/zabbix_proxy.db"
zabbix_proxy_logfile: "/var/log/zabbix/zabbix_proxy.log"
zabbix_proxy_pidfile: "/run/zabbix/zabbix_proxy.pid"
zabbix_proxy_logfile_size: 0
zabbix_proxy_socket_dir: "/run/zabbix"

# --- Configuração do Zabbix Agent ---
zabbix_agent_hostname: "{{ zabbix_proxy_hostname }}"
zabbix_agent_server: "{{ zabbix_server_ip }}"
zabbix_agent_serveractive: "{{ zabbix_server_ip }}"
zabbix_agent_logfile: "/var/log/zabbix/zabbix_agentd.log"

# --- Testes de Conectividade ---
# IPs e gateways a serem verificados para garantir a comunicação básica.
# Usado em: roles/pre_checks/tasks/main.yml
connectivity_test_ips:
  - "{{ zabbix_server_ip }}"
  - "{{ netplan_ipv4_address | ansible.builtin.split('/') | first }}"
  - "{{ netplan_ipv6_address | ansible.builtin.split('/') | first }}"
  - "{{ netplan_ipv4_gateway }}"
  - "{{ netplan_ipv6_gateway }}"
  - "{{ netplan_dns_list }}"

# --- Configurações de Segurança ---
# Porta SSH customizada.
ssh_port: 25085

# Configurações para Fail2Ban (proteção contra ataques de força bruta SSH)
fail2ban_sshd_port: "{{ ssh_port }}"
fail2ban_maxretry: 10          # Número máximo de tentativas antes do banimento
fail2ban_findtime: 10m         # Janela de tempo para contar tentativas (exemplo: 10 minutos)
fail2ban_bantime: 24h        # Tempo de banimento após atingir o limite (exemplo: 24 horas)

# UFW regras para liberar portas a partir de IPs da rede e DNS.
# Adicionada a chave 'direction' para compatibilidade com as tarefas
# de filtragem de tráfego de entrada e saída.
ufw_rules:
  - { rule: allow, from: "{{ netplan_ipv4_gateway }}", port: "{{ ssh_port }}", proto: "tcp", comment: "Gateway IPV4", direction: 'in' }
  - { rule: allow, from: "any", port: "{{ ssh_port }}", proto: "tcp", comment: "Porta SSH", direction: 'in' }
  - { rule: allow, from: "{{ netplan_ipv4_gateway }}", port: "10050", proto: "tcp", comment: "Porta Zabbix Agent - Gateway", direction: 'in' }
  - { rule: allow, from: "{{ netplan_ipv4_gateway }}", port: "10051", proto: "tcp", comment: "Porta Zabbix Proxy - Gateway", direction: 'in' }