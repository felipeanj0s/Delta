{% raw %}
#!/bin/bash

# ======================================================================
# GT Monitoramento 2025
# Script de Gera√ß√£o de Mensagem do Dia (MOTD) - Clean & Modern Edition
# ======================================================================

set -euo pipefail
IFS=$'\n\t'

# -------------------------
# Cores
# -------------------------
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
RESET="\033[0m"

# -------------------------
# Fun√ß√£o para checar status de servi√ßos
# -------------------------
get_status() {
    local service=$1
    if systemctl list-unit-files | grep -q "^${service}.service"; then
        local state
        state=$(systemctl is-active "$service" || echo "inactive")
        case "$state" in
            active) echo -e "${GREEN}‚úî ativo${RESET}" ;;
            inactive) echo -e "${RED}‚úò inativo${RESET}" ;;
            *) echo -e "${YELLOW}${state}${RESET}" ;;
        esac
    else
        echo -e "${YELLOW}n√£o instalado${RESET}"
    fi
}

# -------------------------
# Vari√°veis do sistema
# -------------------------
DEBIAN_VERSION=$(grep PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '"')
HOSTNAME=$(hostname)
IPV4_ADDRS=($(hostname -I | tr ' ' '\n' | grep -v '^127\.0\.0\.1$'))
ZABBIX_AGENT="zabbix-agent2"
ZABBIX_PROXY="zabbix-proxy"
LAST_LOGIN=$(last -n 2 -w | awk 'NR==2 {print $1, $2, $3, $4, $5, $6}')
UPTIME=$(uptime -p | sed 's/up //')
USERS=$(who | wc -l)
MEMORY=$(free -h | awk '/^Mem:/ {printf "%s / %s (%.0f%%)\n",$3,$2,$3/$2*100}')
DISK_ROOT=$(df -h / | awk 'NR==2 {print $3 " / " $2 " (" $5 ")"}')
ZABBIX_AGENT_STATUS=$(get_status "$ZABBIX_AGENT")
ZABBIX_PROXY_STATUS=$(get_status "$ZABBIX_PROXY")

# -------------------------
# Cabe√ßalho
# -------------------------
clear
echo -e "\n${BLUE}################################################################${RESET}"
echo -e "        ${CYAN}üíª Bem-vindo ao servidor: ${GREEN}$HOSTNAME${RESET}"
echo -e "${BLUE}################################################################${RESET}\n"

# -------------------------
# Informa√ß√µes detalhadas
# -------------------------
echo -e " ${YELLOW}‚û° Vers√£o do SO:${RESET}           $DEBIAN_VERSION"

# Endere√ßos IPv4
if [ ${#IPV4_ADDRS[@]} -eq 1 ]; then
    echo -e " ${YELLOW}‚û° Endere√ßo IPv4:${RESET}        ${IPV4_ADDRS[0]}"
else
    echo -e " ${YELLOW}‚û° Endere√ßos IPv4:${RESET}"
    for ip in "${IPV4_ADDRS[@]}"; do
        echo -e "     ‚Ä¢ $ip"
    done
fi

echo -e " ${YELLOW}‚û° √öltimo login:${RESET}          ${LAST_LOGIN:-N/A}"
echo -e " ${YELLOW}‚û° Uptime:${RESET}                $UPTIME"
echo -e " ${YELLOW}‚û° Usu√°rios conectados:${RESET}   $USERS"
echo -e " ${YELLOW}‚û° Mem√≥ria usada:${RESET}         $MEMORY"
echo -e " ${YELLOW}‚û° Disco raiz:${RESET}            $DISK_ROOT\n"

echo -e " ${YELLOW}‚û° Zabbix Agent:${RESET}          $ZABBIX_AGENT_STATUS"
echo -e " ${YELLOW}‚û° Zabbix Proxy:${RESET}          $ZABBIX_PROXY_STATUS\n"

# -------------------------
# Rodap√©
# -------------------------
echo -e "${BLUE}################################################################${RESET}"
echo -e "   ${GREEN}Acesso Concedido.${RESET} ${CYAN}Toda atividade est√° sendo monitorada.${RESET}"
echo -e "${BLUE}################################################################${RESET}\n"
{% endraw %}
