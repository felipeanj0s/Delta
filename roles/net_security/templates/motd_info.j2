#!/bin/bash
# ======================================================================
# GT Monitoramento 2025
# Script de Geração de Mensagem do Dia (MOTD)
# ======================================================================

set -euo pipefail
IFS=$'\n\t'

# -------------------------
# Cores
# -------------------------
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
RESET="\033[0m"

# -------------------------
# Função para checar status de serviços
# -------------------------
get_status() {
    local service=$1
    if systemctl list-unit-files | grep -q "^${service}.service"; then
        local state
        state=$(systemctl is-active "$service" || echo "inactive")
        case "$state" in
            active) echo -e "${GREEN}${state}${RESET}" ;;
            inactive) echo -e "${RED}${state}${RESET}" ;;
            *) echo -e "${YELLOW}${state}${RESET}" ;;
        esac
    else
        echo -e "${YELLOW}not installed${RESET}"
    fi
}

# -------------------------
# Variáveis do sistema (com fallback)
# -------------------------
DEBIAN_VERSION=$(grep PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '"')
IPV4_ADDR="${IPV4_ADDR:-127.0.0.1}"
ZABBIX_AGENT="${ZABBIX_AGENT:-zabbix-agent2}"
ZABBIX_PROXY="${ZABBIX_PROXY:-zabbix-proxy}"
LAST_LOGIN=$(last -n 1 | head -1)
UPTIME=$(uptime -p)
USERS=$(who | wc -l)
MEMORY=$(free -h | awk '/^Mem:/ {printf "%s/%s (%.0f%%)\n",$3,$2,$3/$2*100}')
DISK_ROOT=$(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')
ZABBIX_AGENT_STATUS=$(get_status "$ZABBIX_AGENT")
ZABBIX_PROXY_STATUS=$(get_status "$ZABBIX_PROXY")

# -------------------------
# Cabeçalho
# -------------------------
echo -e "\n${BLUE}################################################################${RESET}"
echo -e "        ${GREEN}Bem-vindo, ${ZABBIX_PROXY}${RESET}"
echo -e "${BLUE}################################################################${RESET}\n"

# -------------------------
# Informações detalhadas
# -------------------------
echo -e " ${GREEN}- Acesso Concedido.${RESET} Toda atividade está sendo monitorada."
echo -e " ${YELLOW}- Versão do SO:${RESET} $DEBIAN_VERSION"
echo -e " ${YELLOW}- Servidor IPv4:${RESET} $IPV4_ADDR"
echo -e " ${YELLOW}- Versão do Zabbix Agent:${RESET} $ZABBIX_AGENT"
echo -e " ${YELLOW}- Último login:${RESET} $LAST_LOGIN"
echo -e " ${YELLOW}- Uptime:${RESET} $UPTIME"
echo -e " ${YELLOW}- Usuários conectados:${RESET} $USERS"
echo -e " ${YELLOW}- Memória usada:${RESET} $MEMORY"
echo -e " ${YELLOW}- Disco raiz:${RESET} $DISK_ROOT"
echo -e " ${YELLOW}- Status Zabbix Agent:${RESET} $ZABBIX_AGENT_STATUS"
echo -e " ${YELLOW}- Status Zabbix Proxy:${RESET} $ZABBIX_PROXY_STATUS\n"

# -------------------------
# Rodapé
# -------------------------
echo -e "${BLUE}################################################################${RESET}\n"
